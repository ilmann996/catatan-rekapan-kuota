<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catatan Kuota — Rekap & PWA</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'><rect width='256' height='256' rx='48' fill='%230ea5e9'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-size='132' fill='white' font-family='system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial'>Q</text></svg>">
  <style>
    :root{--bg:#0b1220;--fg:#eef2ff;--muted:#9aa6c3;--card:#111827;--acc:#0ea5e9;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b1220;color:#eef2ff}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.75));backdrop-filter: blur(8px);border-bottom:1px solid var(--border);padding:.75rem 1rem}
    header h1{margin:0;font-size:1.1rem}
    main{padding:1rem;max-width:1100px;margin:auto}
    .grid{display:grid;gap:.75rem}
    .cards{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.cards{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
    .card h3{margin:.25rem 0;color:var(--muted);font-weight:600;font-size:.9rem}
    .card .big{font-size:1.3rem;font-weight:700}
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0}
    .tab-btn{background:#0f172a;border:1px solid var(--border);color:var(--fg);padding:.5rem .75rem;border-radius:999px;cursor:pointer}
    .tab-btn.active{background:var(--acc);border-color:transparent}
    section{display:none}
    section.active{display:block}
    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin:.75rem 0}
    input, select, button, textarea{background:#0f172a;color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:.5rem .6rem}
    button.primary{background:var(--acc);border-color:transparent;color:#fff}
    button.good{background:var(--ok);border-color:transparent}
    button.bad{background:var(--bad);border-color:transparent}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
    th, td{border-bottom:1px solid var(--border);padding:.5rem;text-align:left}
    th{position:sticky;top:0;background:#0f172a;z-index:1}
    .pill{padding:.15rem .5rem;border-radius:999px;font-size:.75rem}
    .pill.warn{background:rgba(245,158,11,.15);color:#fbbf24}
    .pill.ok{background:rgba(16,185,129,.15);color:#34d399}
    .pill.bad{background:rgba(239,68,68,.15);color:#f87171}
    .muted{color:var(--muted)}
    .right{display:flex;gap:.5rem;margin-left:auto}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    .half{flex:1 1 280px}
    .third{flex:1 1 220px}
    .full{flex:1 1 100%}
    .hint{font-size:.85rem;color:var(--muted)}
    .sticky-sub{position:sticky;top:3.2rem;background:linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.75));backdrop-filter: blur(8px);padding:.5rem;border-bottom:1px solid var(--border);z-index:5}
    .svgchart{width:100%;height:220px;background:#0f172a;border:1px solid var(--border);border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Catatan Kuota — Rekap Harian/Mingguan/Bulanan</h1>
      <div class="right">
        <button id="btnExportJSON" title="Backup data JSON">Export JSON</button>
        <label class="tab-btn" for="importJSONInput" style="cursor:pointer">Import JSON<input id="importJSONInput" type="file" accept="application/json" hidden></label>
      </div>
    </div>
  </header>
  <main>
    <!-- KPI Cards -->
    <div class="grid cards" id="kpiCards">
      <div class="card"><h3>Omzet (hari ini)</h3><div class="big" id="kOmzet">Rp 0</div></div>
      <div class="card"><h3>Modal (hari ini)</h3><div class="big" id="kModal">Rp 0</div></div>
      <div class="card"><h3>Laba (hari ini)</h3><div class="big" id="kLaba">Rp 0</div></div>
      <div class="card"><h3>Transaksi (hari ini)</h3><div class="big" id="kCount">0</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-transaksi">Transaksi</button>
      <button class="tab-btn" data-tab="tab-rekap">Rekap</button>
      <button class="tab-btn" data-tab="tab-pelanggan">Pelanggan</button>
      <button class="tab-btn" data-tab="tab-pengaturan">Pengaturan</button>
    </div>

    <!-- Transaksi -->
    <section id="tab-transaksi" class="active">
      <div class="sticky-sub row">
        <div class="third"><input id="q" placeholder="Cari operator / pelanggan / catatan" /></div>
        <div class="third">
          <select id="fType">
            <option value="">Semua tipe</option>
            <option value="penjualan">Penjualan</option>
            <option value="pengeluaran_usaha">Pengeluaran Usaha</option>
            <option value="pengeluaran_pribadi">Pengeluaran Pribadi</option>
            <option value="hutang">Hutang</option>
            <option value="pelunasan">Pelunasan</option>
          </select>
        </div>
        <div class="third">
          <select id="fStatus">
            <option value="">Semua status</option>
            <option value="lunas">Lunas</option>
            <option value="belum_lunas">Belum Lunas</option>
          </select>
        </div>
        <div class="third"><input id="fFrom" type="date"></div>
        <div class="third"><input id="fTo" type="date"></div>
        <div class="right">
          <button id="btnAdd" class="primary">+ Transaksi</button>
          <button id="btnExportCSV">Export CSV</button>
        </div>
      </div>

      <div class="card" id="formWrap" style="display:none;margin-top:.75rem">
        <h3 style="margin-top:0">Tambah / Edit Transaksi</h3>
        <form id="txForm" class="row">
          <input type="hidden" name="id">
          <div class="third"><label class="hint">Tanggal</label><input type="date" name="date" required></div>
          <div class="third"><label class="hint">Tipe</label>
            <select name="type" required>
              <option value="penjualan">Penjualan</option>
              <option value="pengeluaran_usaha">Pengeluaran Usaha</option>
              <option value="pengeluaran_pribadi">Pengeluaran Pribadi</option>
              <option value="hutang">Hutang</option>
              <option value="pelunasan">Pelunasan</option>
            </select>
          </div>
          <div class="third"><label class="hint">Operator</label><input name="operator" placeholder="Telkomsel/XL/Indosat dll"></div>
          <div class="third"><label class="hint">Denom</label><input name="denom" placeholder="10K/25K/50K"></div>
          <div class="third"><label class="hint">Qty</label><input name="qty" type="number" step="1" min="1" value="1"></div>
          <div class="third"><label class="hint">Harga Jual (Rp)</label><input name="harga_jual" type="number" step="100" min="0"></div>
          <div class="third"><label class="hint">Modal (Rp)</label><input name="modal" type="number" step="100" min="0"></div>
          <div class="third"><label class="hint">Pelanggan</label>
            <select name="pelangganId" id="pelangganSelect"></select>
          </div>
          <div class="third"><label class="hint">Status</label>
            <select name="status">
              <option value="lunas">Lunas</option>
              <option value="belum_lunas">Belum Lunas</option>
            </select>
          </div>
          <div class="third"><label class="hint">Jatuh Tempo (hutang)</label><input name="dueDate" type="date"></div>
          <div class="full"><label class="hint">Catatan</label><input name="catatan" placeholder="Catatan"></div>
          <div class="right full">
            <button type="submit" class="good">Simpan</button>
            <button type="button" id="btnCancel" class="bad">Batal</button>
          </div>
        </form>
      </div>

      <div class="card" style="margin-top:.75rem">
        <div class="row"><h3 style="margin:0">Daftar Transaksi</h3></div>
        <div style="overflow:auto;max-height:55vh">
          <table id="txTable">
            <thead>
              <tr>
                <th>Tanggal</th><th>Tipe</th><th>Operator</th><th>Denom</th><th>Pelanggan</th><th>Qty</th><th>Omzet</th><th>Modal</th><th>Status</th><th>Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card" style="margin-top:.75rem">
        <h3 style="margin-top:0">Tagihan Belum Lunas (Hutang)</h3>
        <div id="dueList" class="hint">Tidak ada tagihan.</div>
      </div>
    </section>

    <!-- Rekap -->
    <section id="tab-rekap">
      <div class="row">
        <div class="third">
          <select id="aggMode">
            <option value="harian">Harian</option>
            <option value="mingguan">Mingguan</option>
            <option value="bulanan">Bulanan</option>
          </select>
        </div>
        <div class="right">
          <button id="btnExportRekapCSV">Export CSV Rekap</button>
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr">
        <svg id="lineChart" class="svgchart" viewBox="0 0 800 220" preserveAspectRatio="none"></svg>
      </div>
      <div class="card" style="margin-top:.75rem">
        <div style="overflow:auto;max-height:55vh">
          <table id="rekapTable">
            <thead>
              <tr>
                <th>Periode</th><th>Transaksi</th><th>Omzet</th><th>Modal</th><th>Laba</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Pelanggan -->
    <section id="tab-pelanggan">
      <div class="card">
        <form id="pelForm" class="row">
          <input type="hidden" name="id">
          <div class="third"><label class="hint">Nama</label><input name="nama" required placeholder="Nama pelanggan"></div>
          <div class="third"><label class="hint">No. WA</label><input name="wa" placeholder="08xxxxxxxxxx"></div>
          <div class="right full">
            <button type="submit" class="good">Simpan Pelanggan</button>
            <button type="button" id="pelReset">Reset</button>
          </div>
        </form>
      </div>
      <div class="card" style="margin-top:.75rem">
        <h3 style="margin-top:0">Daftar Pelanggan</h3>
        <div id="pelList" class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr))"></div>
      </div>
    </section>

    <!-- Pengaturan -->
    <section id="tab-pengaturan">
      <div class="card">
        <h3 style="margin-top:0">Data & Aplikasi</h3>
        <div class="row">
          <button id="btnClear" class="bad">Hapus Semua Data</button>
          <button id="btnInstall" class="primary">Install ke Layar Utama (PWA)</button>
        </div>
        <p class="hint">Aplikasi ini bekerja offline. Service Worker akan menyimpan file agar bisa dibuka tanpa internet setelah sekali dibuka.</p>
      </div>
    </section>
  </main>

  <script>
  // ============ UTIL ==========
  const DB_KEY = 'kuota_ledger_v2';
  const PEL_KEY = 'kuota_pelanggan_v1';
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const todayStr = () => new Date().toISOString().slice(0,10);
  const fmtRp = n => 'Rp ' + (n||0).toLocaleString('id-ID');

  function loadDB(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) || { transactions:[] } }catch{ return { transactions:[] } } }
  function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
  function loadPel(){ try{ return JSON.parse(localStorage.getItem(PEL_KEY)) || { list:[] } }catch{ return { list:[] } } }
  function savePel(p){ localStorage.setItem(PEL_KEY, JSON.stringify(p)); }

  function upsertPelanggan(p){
    const db = loadPel();
    if (p.id){
      const i = db.list.findIndex(x=>x.id===p.id);
      if(i>-1) db.list[i] = {...db.list[i], ...p};
      else db.list.push(p);
    } else {
      p.id = crypto.randomUUID();
      db.list.push(p);
    }
    savePel(db); renderPelanggan(); fillPelangganSelect();
  }

  function addTransaction(tx){
    const db = loadDB();
    const payload = {
      id: tx.id || crypto.randomUUID(),
      date: tx.date || todayStr(),
      type: tx.type || 'penjualan',
      operator: tx.operator || '',
      denom: tx.denom || '',
      qty: Number(tx.qty||1),
      harga_jual: Number(tx.harga_jual||0),
      modal: Number(tx.modal||0),
      pelangganId: tx.pelangganId || '',
      status: tx.status || 'lunas',
      dueDate: tx.dueDate || '',
      catatan: tx.catatan || ''
    };
    const idx = db.transactions.findIndex(t=>t.id===payload.id);
    if(idx>-1) db.transactions[idx] = payload; else db.transactions.push(payload);
    saveDB(db);
    renderAll();
  }
  function deleteTransaction(id){
    const db = loadDB(); db.transactions = db.transactions.filter(t=>t.id!==id); saveDB(db); renderAll();
  }
  function markLunas(id){
    const db = loadDB(); const t = db.transactions.find(x=>x.id===id); if(t){t.status='lunas'; saveDB(db); renderAll();}
  }

  // ============ FILTER & TABLE ==========
  function txMatches(t, q, type, status, from, to){
    const hay = [t.operator, t.denom, t.catatan, getPelName(t.pelangganId)].join(' ').toLowerCase();
    const okQ = !q || hay.includes(q.toLowerCase());
    const okType = !type || t.type===type;
    const okStatus = !status || t.status===status;
    const d = t.date;
    const okFrom = !from || d >= from;
    const okTo = !to || d <= to;
    return okQ && okType && okStatus && okFrom && okTo;
  }

  function renderTable(){
    const q = $('#q').value.trim();
    const type = $('#fType').value; const status = $('#fStatus').value;
    const from = $('#fFrom').value; const to = $('#fTo').value;
    const db = loadDB();
    const rows = db.transactions
      .filter(t=>txMatches(t,q,type,status,from,to))
      .sort((a,b)=> (a.date+b.id) < (b.date+a.id) ? 1 : -1);
    const tb = $('#txTable tbody');
    tb.innerHTML = rows.map(t=>{
      const omzet = t.type==='penjualan' ? t.harga_jual*t.qty : (t.type==='pelunasan'? t.harga_jual : 0);
      const modal = t.type==='penjualan' ? t.modal*t.qty : (t.type==='pengeluaran_usaha'? t.modal : 0);
      const statusPill = t.status==='lunas'? '<span class="pill ok">Lunas</span>' : '<span class="pill warn">Belum</span>';
      return `<tr>
        <td>${t.date}</td>
        <td>${t.type.replace('_',' ')}</td>
        <td>${t.operator||'-'}</td>
        <td>${t.denom||'-'}</td>
        <td>${getPelName(t.pelangganId)||'-'}</td>
        <td>${t.qty||'-'}</td>
        <td>${fmtRp(omzet)}</td>
        <td>${fmtRp(modal)}</td>
        <td>${statusPill}</td>
        <td>
          <button data-act="edit" data-id="${t.id}">Edit</button>
          <button data-act="del" data-id="${t.id}" class="bad">Hapus</button>
          ${t.status!=='lunas'? `<button data-act="lunas" data-id="${t.id}" class="good">Tandai Lunas</button>`:''}
        </td>
      </tr>`;
    }).join('');

    // actions
    tb.querySelectorAll('button').forEach(btn=>{
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      btn.onclick = () => {
        if(act==='del'){ if(confirm('Hapus transaksi ini?')) deleteTransaction(id); }
        else if(act==='lunas'){ markLunas(id); }
        else if(act==='edit'){ openForm(loadDB().transactions.find(x=>x.id===id)); }
      };
    });
  }

  // ============ KPI ==========
  function calcSummary(list){
    let omzet=0, modal=0, count=0;
    for(const t of list){
      if(t.type==='penjualan'){
        omzet += t.harga_jual * t.qty;
        modal += t.modal * t.qty;
        count += 1;
      } else if(t.type==='pengeluaran_usaha'){
        modal += t.modal; // biaya operasional
      } else if(t.type==='pelunasan'){
        omzet += t.harga_jual; // pelunasan masuk ke kas/omzet
        count += 1;
      }
    }
    return {omzet, modal, laba: omzet - modal, count};
  }

  function updateKPI(){
    const db = loadDB();
    const today = db.transactions.filter(t=>t.date===todayStr());
    const s = calcSummary(today);
    $('#kOmzet').textContent = fmtRp(s.omzet);
    $('#kModal').textContent = fmtRp(s.modal);
    $('#kLaba').textContent = fmtRp(s.laba);
    $('#kCount').textContent = s.count;
  }

  // ============ DUE LIST ==========
  function renderDue(){
    const db = loadDB();
    const now = todayStr();
    const due = db.transactions.filter(t=>t.type==='hutang' && t.status!=='lunas');
    if(!due.length){ $('#dueList').innerHTML = 'Tidak ada tagihan.'; return; }
    const html = '<table><thead><tr><th>Pelanggan</th><th>Nominal</th><th>Jatuh Tempo</th><th>Aksi</th></tr></thead><tbody>'+
      due.sort((a,b)=> (a.dueDate||'9999-99-99').localeCompare(b.dueDate||'9999-99-99'))
         .map(t=>`<tr>
           <td>${getPelName(t.pelangganId)||'-'}</td>
           <td>${fmtRp(t.harga_jual*t.qty)}</td>
           <td>${t.dueDate? t.dueDate + (t.dueDate < now ? ' <span class="pill bad">Lewat</span>':'' ) : '-'}</td>
           <td><button class="good" data-due="lunas" data-id="${t.id}">Lunas</button></td>
         </tr>`).join('') + '</tbody></table>';
    $('#dueList').innerHTML = html;
    $$('#dueList [data-due="lunas"]').forEach(b=> b.onclick = ()=> markLunas(b.getAttribute('data-id')));
  }

  // ============ REKAP ==========
  function keyWeek(d){ // ISO week key
    const dt = new Date(d+'T00:00:00');
    const day = (dt.getUTCDay()+6)%7; // Monday=0
    dt.setUTCDate(dt.getUTCDate()-day+3);
    const firstThursday = new Date(Date.UTC(dt.getUTCDFullYear?dt.getUTCDFullYear():dt.getUTCFullYear(),0,4));
  }
  // NOTE: Fix minor typo (Safari quirk)
  function keyWeek(d){
    const dt = new Date(d+'T00:00:00');
    const day = (dt.getUTCDay()+6)%7;
    dt.setUTCDate(dt.getUTCDate()-day+3);
    const firstThursday = new Date(Date.UTC(dt.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((dt - firstThursday)/86400000 - 3 + ((firstThursday.getUTCDay()+6)%7))/7);
    const y = dt.getUTCFullYear();
    return `${y}-W${String(week).padStart(2,'0')}`;
  }
  function keyMonth(d){ return d.slice(0,7); }

  function aggregate(mode){
    const db = loadDB();
    const map = new Map();
    for(const t of db.transactions){
      const key = mode==='harian'? t.date : (mode==='mingguan'? keyWeek(t.date) : keyMonth(t.date));
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(t);
    }
    const rows = Array.from(map.entries()).map(([k,list])=> ({ key:k, ...calcSummary(list)}));
    rows.sort((a,b)=> a.key.localeCompare(b.key));
    return rows;
  }

  function renderRekap(){
    const mode = $('#aggMode').value;
    const rows = aggregate(mode);
    const tb = $('#rekapTable tbody');
    tb.innerHTML = rows.map(r=>`<tr>
      <td>${r.key}</td>
      <td>${r.count}</td>
      <td>${fmtRp(r.omzet)}</td>
      <td>${fmtRp(r.modal)}</td>
      <td><b>${fmtRp(r.laba)}</b></td>
    </tr>`).join('');
    drawLineChart(rows.map(r=>({x:r.key,y:r.laba})), 'Laba');
  }

  // ============ SIMPLE SVG LINE CHART ==========
  function drawLineChart(points, label){
    const svg = $('#lineChart');
    const W=800,H=220, P=32; // padding
    svg.innerHTML = '';
    if(points.length===0){ svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="#9aa6c3">Belum ada data</text>`; return; }
    // map x to index spacing
    const ys = points.map(p=>p.y);
    const minY = Math.min(0, ...ys); // baseline at 0
    const maxY = Math.max(...ys, 10);
    const scaleX = i => P + (W-2*P) * (i/(points.length-1 || 1));
    const scaleY = v => H-P - (H-2*P) * ((v - minY) / ((maxY-minY)||1));

    // grid lines
    const ySteps = 4;
    for(let s=0; s<=ySteps; s++){
      const y = H-P - (H-2*P)*(s/ySteps);
      const val = minY + (maxY-minY)*(s/ySteps);
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', String(P)); line.setAttribute('x2', String(W-P));
      line.setAttribute('y1', String(y)); line.setAttribute('y2', String(y));
      line.setAttribute('stroke', '#1f2937'); line.setAttribute('stroke-width', '1');
      svg.appendChild(line);
      const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
      txt.setAttribute('x', '4'); txt.setAttribute('y', String(y)); txt.setAttribute('fill', '#9aa6c3');
      txt.setAttribute('font-size','10'); txt.textContent = 'Rp ' + Math.round(val).toLocaleString('id-ID');
      svg.appendChild(txt);
    }

    // path
    const d = points.map((p,i)=> `${i?'L':'M'}${scaleX(i)},${scaleY(p.y)}`).join(' ');
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','#0ea5e9'); path.setAttribute('stroke-width','2');
    svg.appendChild(path);

    // dots
    points.forEach((p,i)=>{
      const cx=scaleX(i), cy=scaleY(p.y);
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx', String(cx)); c.setAttribute('cy', String(cy)); c.setAttribute('r','3'); c.setAttribute('fill','#0ea5e9');
      svg.appendChild(c);
    });

    // labels (x)
    const step = Math.ceil(points.length / 8);
    points.forEach((p,i)=>{
      if(i%step===0 || i===points.length-1){
        const tx = document.createElementNS('http://www.w3.org/2000/svg','text');
        tx.setAttribute('x', String(scaleX(i))); tx.setAttribute('y', String(H-8)); tx.setAttribute('fill','#9aa6c3');
        tx.setAttribute('font-size','10'); tx.setAttribute('text-anchor','middle'); tx.textContent = p.x;
        svg.appendChild(tx);
      }
    });

    // title
    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x','50%'); title.setAttribute('y','16'); title.setAttribute('fill','#eef2ff'); title.setAttribute('text-anchor','middle');
    title.textContent = `Grafik ${label} (${points.length} poin)`; svg.appendChild(title);
  }

  // ============ EXPORT / IMPORT ==========
  function exportCSV(rows, header){
    const csv = [header.join(',')].concat(rows.map(r=> r.map(x=>{
      const s = (x==null? '' : String(x));
      return '"'+ s.replace(/"/g,'""') +'"';
    }).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'export-'+Date.now()+'.csv'; a.click();
  }

  $('#btnExportCSV').onclick = ()=>{
    const db = loadDB();
    const rows = db.transactions.map(t=>[
      t.id, t.date, t.type, t.operator, t.denom, t.qty, t.harga_jual, t.modal, getPelName(t.pelangganId), t.status, t.dueDate, t.catatan
    ]);
    exportCSV(rows, ['id','date','type','operator','denom','qty','harga_jual','modal','pelanggan','status','dueDate','catatan']);
  };
  $('#btnExportRekapCSV').onclick = ()=>{
    const mode = $('#aggMode').value; const rows = aggregate(mode).map(r=>[r.key,r.count,r.omzet,r.modal,r.laba]);
    exportCSV(rows, ['periode','count','omzet','modal','laba']);
  };

  $('#btnExportJSON').onclick = ()=>{
    const data = { transactions: loadDB().transactions, pelanggan: loadPel().list };
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'backup-kuota-'+todayStr()+'.json'; a.click();
  };
  $('#importJSONInput').onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const text = await f.text();
    try{
      const data = JSON.parse(text);
      if(data.transactions) localStorage.setItem(DB_KEY, JSON.stringify({transactions:data.transactions}));
      if(data.pelanggan) localStorage.setItem(PEL_KEY, JSON.stringify({list:data.pelanggan}));
      alert('Import berhasil'); renderAll();
    }catch(err){ alert('Gagal import: '+err.message); }
  };

  // ============ FORM ==========
  function openForm(tx){
    $('#formWrap').style.display = 'block';
    const f = $('#txForm');
    f.reset();
    f.date.value = todayStr();
    f.status.value = 'lunas';
    if(tx){
      f.id.value = tx.id;
      f.date.value = tx.date;
      f.type.value = tx.type; f.operator.value = tx.operator; f.denom.value = tx.denom;
      f.qty.value = tx.qty; f.harga_jual.value = tx.harga_jual; f.modal.value = tx.modal;
      f.pelangganId.value = tx.pelangganId || ''; f.status.value = tx.status; f.dueDate.value = tx.dueDate || '';
      f.catatan.value = tx.catatan || '';
    }
    f.type.onchange = ()=>{
      const isHutang = f.type.value==='hutang';
      if(isHutang){ f.status.value='belum_lunas'; }
    };
  }
  function closeForm(){ $('#formWrap').style.display='none'; $('#txForm').reset(); }
  $('#btnAdd').onclick = ()=> openForm();
  $('#btnCancel').onclick = ()=> closeForm();
  $('#txForm').onsubmit = (e)=>{
    e.preventDefault(); const f = e.target; const fd = new FormData(f);
    const qty = Number(fd.get('qty')||1); const hj = Number(fd.get('harga_jual')||0); const modal = Number(fd.get('modal')||0);
    if(qty<=0) return alert('Qty harus > 0'); if(hj<0||modal<0) return alert('Harga/Modal tidak valid');
    addTransaction(Object.fromEntries(fd.entries())); closeForm();
  };

  // ============ PELANGGAN ==========
  function getPelName(id){ if(!id) return ''; const p = loadPel().list.find(x=>x.id===id); return p? p.nama : ''; }
  function formatWa(wa){ if(!wa) return ''; let s=wa.trim(); if(s.startsWith('+')) s=s.slice(1); if(s.startsWith('62')) return s; if(s.startsWith('0')) return '62'+s.slice(1); return s; }

  function renderPelanggan(){
    const pel = loadPel().list;
    const wrap = $('#pelList');
    if(!pel.length){ wrap.innerHTML = '<p class="hint">Belum ada pelanggan.</p>'; return; }
    const db = loadDB();
    wrap.innerHTML = pel.map(p=>{
      const total = db.transactions.filter(t=>t.pelangganId===p.id && (t.type==='penjualan'||t.type==='pelunasan'))
                      .reduce((sum,t)=> sum + (t.type==='penjualan'? t.harga_jual*t.qty : t.harga_jual), 0);
      const hutang = db.transactions.filter(t=>t.pelangganId===p.id && t.type==='hutang' && t.status!=='lunas')
                      .reduce((s,t)=> s + t.harga_jual*t.qty, 0);
      const wa = formatWa(p.wa);
      const waLink = wa? `https://wa.me/${wa}` : '';
      return `<div class="card">
        <div class="row">
          <div>
            <div style="font-weight:700">${p.nama}</div>
            <div class="hint">${p.wa||''}</div>
          </div>
          <div class="right">
            ${waLink? `<a href="${waLink}" target="_blank"><button>Chat WA</button></a>`:''}
            <button data-pel="edit" data-id="${p.id}">Edit</button>
          </div>
        </div>
        <div class="hint" style="margin-top:.5rem">Total Belanja: <b>${fmtRp(total)}</b> · Hutang: <b class="pill warn">${fmtRp(hutang)}</b></div>
        <div style="margin-top:.5rem"><button data-pel="history" data-id="${p.id}">Lihat Riwayat</button></div>
      </div>`;
    }).join('');
    $$('#pelList [data-pel]').forEach(btn=>{
      const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-pel');
      btn.onclick = ()=>{
        if(act==='edit'){
          const p = loadPel().list.find(x=>x.id===id);
          const f = $('#pelForm'); f.id.value=p.id; f.nama.value=p.nama; f.wa.value=p.wa||'';
          window.scrollTo({top:0,behavior:'smooth'});
        } else if(act==='history'){
          const db = loadDB(); const list = db.transactions.filter(t=>t.pelangganId===id).sort((a,b)=>a.date<b.date?1:-1);
          alert(list.map(t=> `${t.date} · ${t.type} · ${t.operator||'-'} ${t.denom||''} · ${fmtRp((t.type==='penjualan'? t.harga_jual*t.qty : (t.type==='pelunasan'?t.harga_jual:0)))}` ).join('\n') || 'Belum ada transaksi');
        }
      };
    });
  }

  const pelForm = $('#pelForm');
  pelForm.onsubmit = (e)=>{ e.preventDefault(); const fd = new FormData(pelForm);
    const nama = (fd.get('nama')||'').trim(); if(!nama) return alert('Nama wajib');
    const wa = (fd.get('wa')||'').trim();
    upsertPelanggan({ id: fd.get('id')||undefined, nama, wa }); pelForm.reset(); };
  $('#pelReset').onclick = ()=> pelForm.reset();

  function fillPelangganSelect(){
    const sel = $('#pelangganSelect');
    const list = loadPel().list;
    sel.innerHTML = '<option value="">-</option>' + list.map(p=>`<option value="${p.id}">${p.nama}</option>`).join('');
  }

  // ============ EVENTS ==========
  $$('#q,#fType,#fStatus,#fFrom,#fTo').forEach(el=> el.addEventListener('input', ()=>{ renderTable(); updateKPI(); renderRekap(); renderDue(); }));
  $('#aggMode').onchange = ()=> renderRekap();

  // ============ CLEAR ==========
  $('#btnClear').onclick = ()=>{ if(confirm('Hapus semua data?')) { localStorage.removeItem(DB_KEY); localStorage.removeItem(PEL_KEY); renderAll(); } };

  // ============ PWA INSTALL ==========
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; });
  $('#btnInstall').onclick = async ()=>{ if(!deferredPrompt){ alert('Buka dari Chrome/Edge Android agar bisa install.'); return; } deferredPrompt.prompt(); deferredPrompt = null; };

  // ============ RENDER ALL ==========
  function renderAll(){ fillPelangganSelect(); renderTable(); updateKPI(); renderRekap(); renderPelanggan(); renderDue(); }

  // ============ TABS ==========
  $$('.tab-btn').forEach(btn=> btn.onclick = ()=>{ $$('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const id = btn.getAttribute('data-tab'); $$('section').forEach(s=> s.classList.remove('active')); $('#'+id).classList.add('active'); });

  // init
  (function init(){
    // sample data on first run
    const db = loadDB(); if(db.transactions.length===0){
      const pel = loadPel(); if(pel.list.length===0){
        upsertPelanggan({nama:'Andi', wa:'081234567890'});
        upsertPelanggan({nama:'Budi', wa:'082233344455'});
      }
      const pid = loadPel().list[0]?.id || '';
      addTransaction({date: todayStr(), type:'penjualan', operator:'Telkomsel', denom:'10K', qty:1, harga_jual:12000, modal:11000, pelangganId:pid, status:'lunas'});
      addTransaction({date: todayStr(), type:'pengeluaran_usaha', modal:5000, catatan:'Plastik & pulsa toko'});
      addTransaction({date: todayStr(), type:'hutang', operator:'XL', denom:'25K', qty:1, harga_jual:27000, modal:25000, pelangganId:pid, status:'belum_lunas', dueDate: todayStr()});
    }
    renderAll();

    // service worker
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }
  })();
  </script>
</body>
</html>
